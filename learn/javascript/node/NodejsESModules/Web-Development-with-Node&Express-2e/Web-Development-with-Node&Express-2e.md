# web development with node and express 2e

## chapter 9 쿠키와 세션

- HTTP는 **상태가 없는**(stateless) 프로토콜

  - 상태가 없다는 말은 브라우저에서 어떤 페이지를 불러온 다음,
    같은 웹사이트의 다른 페이지로 이동할 때,
    같은 브라우저가 같은 사이트에 방문한다는 사실을 알아낼 방법이 없다는 뜻
  - 서버에도, 브라우저에도 없음.
  - 달리 말하면, **모든 HTTP 요청에는 서버에서 그 요청을 수행할 때 필요한 정보가 모두 들어 있다는 뜻**
  - 웹은 이런 방식으로 동작
  - 하지만 이런 방식에는 문제가 있음
    - 이대로 진행한다면 사용자는 사이트에서 이동할 때마다 로그인이 풀릴 것
    - 미디어 스트리밍도 제대로 동작하지 않음
    - 페이지를 이동할 때마다 해당 웹사이트에서 설정한 내용이 모두 사라짐.
    - 이를 해결하기 위해 '상태'를 보존할 방법이 필요했고 따라서 쿠키와 세션이 등장함

- 쿠키에 관해 알아둬야 할 중요한 내용
  - **사용자가 쿠키 내용을 볼 수 있습니다.**
    - 서버에서 클라이언트에 보내는 쿠키는 모두 클라이언트에서 볼 수 있음
    - 쿠키를 암호화해서 콘텐츠를 보호할 수 있긴 하지만, 떳떳한 목적으로만 사용한다면 굳이 암호화할 이유가 없음
    - **서명된**(signed) 쿠키는 콘텐츠를 읽기 어렵게 만들긴 하지만, 암호화라고 할 수 있는 수준은 아님
  - **사용자가 쿠키를 삭제하거나 금지할 수 있습니다.**
    - 사용자는 쿠키 전체에 대한 권한이 있고, 브라우저에는 쿠키를 개별적으로, 또는 한꺼번에 삭제하는 기능이 있음
    - 사용자가 굳이 쿠키를 삭제할 이유는 없지만, 쿠키를 지워서 사용자 설정을 초기화하는 등 테스트 목적으로는 유용함
    - 또한 사용자가 쿠키를 금지할 수도 있음
      - 이런 경우엔 골치가 아픈데, 쿠키 없이도 제대로 동작할 수 있는 웹 애플리케이션은 정말 단순한 기능 말고는 수행하기 어려움
  - **일반적인 쿠키는 변조될 수 있습니다.**
    - 브라우저에서 요청을 보낼 때 동봉하는 쿠키를 맹목적으로 믿는다면 공격에 문을 열어두는 것과 마찬가지.
    - 예를 들어 쿠키에 포함된 코드를 실행하는 건 미련하다고 해도 할 말이 없음
    - 쿠키 변조의 위험을 없애려면 서명된 쿠키를 사용
  - **쿠키는 공격에 사용될 수 있습니다.**
    - 최근 몇 년 사이 사이트 간 스크립틍(cross-site scripting attack - XSS) 공격이 급증
    - XSS 공격중에는 악의적인 자바스크립트 코드로 쿠키 콘텐츠를 바꾸는 방법도 있음
    - XSS 공격도 서버에 전송되는 쿠키를 맹신해서는 안 되는 이유 중 하나
    - 서명된 쿠키를 사용하면 사용자나 자바스크립트 코드로 쿠키를 변조했을 경우 그 흔적이 명백히 드러나므로 공격을 막는 데 도움이 됨.
    - 또한 쿠키 변경은 오직 서버에서만 가능하게끔 하는 설정도 있음
      - 이런 쿠키는 활용도가 조금 떨어질 수는 있지만 훨씬 안전함
  - **쿠키를 남용하면 사용자가 눈치챕니다.**
    - 사용자의 컴퓨터에 쿠키나 데이터를 너무 많이 저장하면 사용자를 짜증나게 할 수 있으므로 피해야 함
    - 쿠키는 최소한으로 유지
  - **가급적 쿠키보다 세션을 사용하세요.**
    - 대부분의 경우 **세션**을 통해 상태를 관리하며 일반적으로 세션이 더 현명한 선택
    - 세션은 더 쉽고, 사용자에게 악영향도 적으며, 더 안전함
    - 물론 세션 자체가 쿠키에 의존하긴 하지만, 익스프레스를 쓰면 번거로운 작업이 많이 줄어듬

### 9.1 자격 증명 위임

- 쿠키 보안을 위해서는 **쿠키 시크릿**(cookie secret)이 필요
  - 쿠키 시크릿은 서버에서 쿠키를 클라이언트에 보내기 전에 암호화할 때 사용하는 문자열
  - 기억해야하지는 않으므로 랜덤한 문자열을 써도 됨
  - 책에서는 .credentials.development.json 파일을 만들어서 사용
    - env 같은 역할인듯
  - 실수로 자격 증명을 저장소에 추가하는 일이 없도록 .gitignore 파일에 .credentials.\* 를 추가

### 9.2 익스프레스와 쿠키

- 앱에서 쿠키를 사용하려면 cookie-parse 미들웨어를 추가해야 함

  - npm install cookie-parser 로 설치하고 meadowlark.js에 다음을 추가
    ```js
    const cookieParser = require("cookie-parser");
    app.use(cookieParser(credentials.cookieSecret));
    ```
  - 이제 응답 객체에 접근할 수 있는 곳 어디서든 쿠키를 쓸 수 있음.
    - 예를 들어 홈페이지에서 쿠키를 보낼 때는 핸드러를 다음과 같이 수정(`lib/handlers.js`)
    ```js
    exports.home = (req, res) => {
      res.cookie("monster", "nom nom");
      res.cookie("signed_monster", "nom nom", { signed: true });
      res.render("home");
    };
    ```
  - 서명된 쿠키는 일반적인 쿠키보다 우선순위가 높음

    - 서명된 쿠키에 signed_monster란 이름을 붙인다면, 같은 이름의 일반 쿠키는 사용할 수 없음

  - 클라이언트에서 보낸 쿠키에 접근할 때는 요청 객체의 cookie나 signedCookie프로퍼티에 접근함

  ```js
  const monster = req.cookies.monster;
  const signedMonster = req.signedCookies.signed_monster;
  ```

  - 쿠키를 삭제할 때는 req.clearCookie를 사용

  ```js
  req.clearCookie("monster");
  ```

- 쿠키에서 사용할 수 있는 옵션
  - domain
    - 쿠키에 도메인을 연결. 즉, 특정 서브도메인에 쿠키를 할당함
    - 하지만 현재 서버가 실행 중인 도메인이 아닌 다른 도메인과 연결할 수는 없음
    - 시도하더라도 아무 일도 일어나지 않음
  - path
    - 쿠키가 적용될 경로를 지정
    - 이 경로에는 암시적인 와일드카드가 적용됨
    - 경로에 기본값인 /를 사용하면 사이트의 모든 페이지에 쿠키가 적용됨
    - 경로를 /foo로 설정하면 /foo, /foo/bar 등에 적용됨
  - maxAge
    - 클라이언트가 쿠키를 얼마나 오래 보관하고 있어야 하는지 밀리초 단위로 저장
    - 이 옵션을 설정하지 않으면 쿠키는 브라우저를 닫을 때 삭제됨
    - expires 옵션에서 만료 날짜를 설정할 수 있긴 하지만 문법이 복잡함
    - 필자는 maxAge를 권함
  - secure
    - 이 옵션을 설정하면 보안(HTTPS) 연결을 통해서만 쿠키를 전송
  - httpOnly
    - 이 옵션을 true로 설정하면 서버에서만 쿠키를 수정함
    - 즉, 클라이언트 사이드 자바스크립트는 쿠키를 수정할 수 없음
    - XSS 공격을 막는 데 도움이 됨
  - signed
    - 이 옵션을 true로 설정하면 쿠키에 서명을 해서 res.cookies가 아니라 res.signedCookies에서 접근할 수 있게 함.
    - 서명된 쿠키가 변조되면 서버는 그 쿠키를 거부하고 원래 값으로 초기화 함

### 9.3 쿠키 실험

- 브라우저에서 볼 수 있음
- 크롬 - 개발자 도구 - 애플리케이션 탭 - 왼쪽에 있는 트리에서 Cookies 를 볼 수 있음

### 9.4 세션

- **세션**은 상태를 좀 더 쉽게 관리하는 수단
  - 세션을 사용하기 위해서는 클라이언트에 뭔가 저장해야 함
  - 아무것도 없다면 서버는 클라이언트를 식별할 수 없음
  - 일반적으로 쿠키에 고유한 식별자를 담아서 사용함
  - 그러면 서버는 이 식별자를 보고 적합한 세션 정보를 가져옴
- 세션을 구현하는 방법은 크게 두 가지
  - 하나는 모든 정보를 쿠키에 저장하는 방법 - **쿠키 기반 세션**
    - 쿠키에 비해 편리하다는 점 외에는 그다지 장점이 없음
    - 쿠키 기반 세션은 세션에 추가하는 정보가 전부 클라이언트에 저장되는 것은 마찬가지이므로 필자는 이 방법을 권하지 않음
    - 쿠키 기반 세션은 세션에 아주 적은 정보만 저장하며 사용자가 그 정보에 접근할 수 있어도 괜찮고, 시간이 지나면서 통제 불가능해질 만큼 커지지 않을 때에만 쓰길 권함
    - 쿠키 기반 세션을 사용하고 싶으면 cookie-session 미들웨어를 읽어볼 것
  - 다른 하나는 쿠키에 고유 식별자만 저장하고 나머지 정보는 모두 서버에 저장하는 방법

#### 9.4.1 메모리에 저장
